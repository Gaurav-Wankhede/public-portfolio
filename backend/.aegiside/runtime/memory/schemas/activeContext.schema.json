{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$defs": {
    "task_id": {"type": "string"},
    "roadmap_milestone_id": {"type": "string"},
    "error_id": {"type": "string"}
  },
  "type": "object",
  "required": ["schema_version", "last_updated", "metrics", "event_tracking"],
  "properties": {
    "schema_version": {"type": "string"},
    "last_updated": {"type": "string"},
    "metrics": {
      "type": "object",
      "description": "Local session metrics - NO total_rl_score stored here. Reference progress.json for authoritative RL score.",
      "required": ["rl_source_ref", "tasks_completed"],
      "properties": {
        "rl_source_ref": {"type": "string", "const": "progress.json", "description": "SINGLE SOURCE OF TRUTH for total_rl_score"},
        "tasks_completed": {"type": "integer"},
        "tasks_pending": {"type": "integer"},
        "constitutional_compliance": {"type": "number"},
        "session_readiness": {"type": "number"},
        "emd_compliance": {"type": "string"}
      }
    },
    "current_execution": {
      "type": "object",
      "properties": {
        "task_id": {"$ref": "#/$defs/task_id"},
        "task_name": {"type": "string"},
        "roadmap_milestone_id": {"$ref": "#/$defs/roadmap_milestone_id"},
        "status": {"type": "string"},
        "priority": {"type": "string"},
        "blocker_reason": {"type": "string"}
      }
    },
    "task_queue": {
      "type": "object",
      "description": "Merged from kanban.schema.json - Task management columns",
      "properties": {
        "todo": {"type": "array", "items": {"type": "object", "properties": {"id": {"type": "string"}, "title": {"type": "string"}, "priority": {"type": "string"}, "tags": {"type": "array", "items": {"type": "string"}}, "added_at": {"type": "string", "format": "date-time"}}}},
        "in_progress": {"type": "array", "items": {"type": "object", "properties": {"id": {"type": "string"}, "title": {"type": "string"}, "priority": {"type": "string"}, "tags": {"type": "array", "items": {"type": "string"}}, "started_at": {"type": "string", "format": "date-time"}}}},
        "done": {"type": "array", "items": {"type": "object", "properties": {"id": {"type": "string"}, "title": {"type": "string"}, "completed_at": {"type": "string", "format": "date-time"}, "tags": {"type": "array", "items": {"type": "string"}}, "rl_impact": {"type": "number"}}}},
        "approved": {"type": "array", "description": "Constitutional verification passed", "items": {"type": "object", "required": ["id", "title", "approval_metadata"], "properties": {"id": {"type": "string"}, "title": {"type": "string"}, "approved_at": {"type": "string", "format": "date-time"}, "constitutional_compliance": {"type": "number", "minimum": 80}, "approval_metadata": {"type": "object", "required": ["chief_justice_approved", "opposition_verified"], "properties": {"chief_justice_approved": {"type": "boolean"}, "opposition_verified": {"type": "boolean"}, "constitutional_compliance_verified": {"type": "boolean"}, "vetoed": {"type": "boolean", "default": false}}}}}}
      }
    },
    "rl_runtime": {
      "type": "object",
      "description": "Real-time RL architecture state",
      "properties": {
        "current_gae_advantage": {"type": "number"},
        "session_kl_divergence": {"type": "number"},
        "active_branch": {"type": "string", "enum": ["task_success", "safety", "alignment", "efficiency", "learning"]},
        "exploit_mode": {"type": "boolean", "description": "true=exploitation(70%), false=exploration(30%)"},
        "strategy_effectiveness": {"type": "number", "minimum": 0, "maximum": 1, "description": "Current strategy effectiveness (triggers auto-adapt if <0.8)"},
        "autonomous_loop_active": {"type": "boolean", "description": "Recursive self-teaching loop active"},
        "parallel_workers": {"type": "integer", "minimum": 1, "description": "Number of concurrent workers"},
        "attention_budget_allocation": {
          "type": "object",
          "description": "GAP 1 CONTEXT BUDGET: n² attention formula for 8-schema. attention_per_schema = (base_tokens × priority_weight) / sum(priorities). Reduces token waste by 40%",
          "properties": {
            "base_tokens": {"type": "integer", "description": "Total available tokens"},
            "scratchpad_allocation": {"type": "number", "description": "Priority weight 0.3"},
            "activeContext_allocation": {"type": "number", "description": "Priority weight 0.25"},
            "mistakes_allocation": {"type": "number", "description": "Priority weight 0.2"},
            "systemPatterns_allocation": {"type": "number", "description": "Priority weight 0.1"},
            "progress_allocation": {"type": "number", "description": "Priority weight 0.1"},
            "roadmap_allocation": {"type": "number", "description": "Priority weight 0.05"},
            "memory_allocation": {"type": "number", "description": "Priority weight 0.0 (via MCP)"},
            "kanban_allocation": {"type": "number", "description": "Priority weight 0.0 (via MCP)"}
          }
        }
      }
    },
    "event_tracking": {
      "type": "array",
      "description": "TOP-APPEND MANDATORY: Newest event MUST be at [0]. Prepend, never append.",
      "maxItems": 100,
      "items": {
        "type": "object",
        "required": ["id", "timestamp", "type", "task_id"],
        "properties": {
          "id": {"type": "string"},
          "timestamp": {"type": "string", "format": "date-time"},
          "type": {"type": "string"},
          "task_id": {"type": "string"},
          "description": {"type": "string"},
          "context": {"type": "object"},
          "rl_reward": {"type": "number", "minimum": 0},
          "rl_penalty": {"type": "number", "maximum": 0}
        }
      }
    },
    "session_context": {
      "type": "object",
      "properties": {
        "session_id": {"type": "string"},
        "workspace": {"type": "string"},
        "active_branch": {"type": "string"},
        "session_duration_minutes": {"type": "integer", "minimum": 0},
        "initialized_at": {"type": "string", "format": "date-time"},
        "current_time": {"type": "string", "format": "date-time"},
        "constitution_loaded": {"type": "boolean"},
        "articles_count": {"type": "integer"},
        "technology_stack": {"type": "string"}
      }
    },
    "file_operation_intent": {
      "type": "object",
      "description": "Protocol: file_operation_semantics_enforcement - Track UPDATE/CREATE/ANALYZE intent",
      "properties": {
        "last_intent_type": {"type": "string", "enum": ["UPDATE", "CREATE", "ANALYZE"]},
        "verb_extracted": {"type": "string", "description": "Extracted verb from user query"},
        "confidence": {"type": "number", "minimum": 0, "maximum": 1, "description": "Confidence in intent detection"},
        "timestamp": {"type": "string", "format": "date-time"}
      }
    },
    "confidence_calculation": {
      "type": "object",
      "description": "Protocol: confidence_scoring_implementation - Store confidence factor breakdown",
      "properties": {
        "keyword_match_score": {"type": "number", "minimum": 0, "maximum": 1},
        "semantic_similarity_score": {"type": "number", "minimum": 0, "maximum": 1},
        "memory_hit_score": {"type": "number", "minimum": 0, "maximum": 1},
        "historical_accuracy_score": {"type": "number", "minimum": 0, "maximum": 1},
        "final_confidence": {"type": "number", "minimum": 0, "maximum": 1},
        "execution_band": {"type": "string", "enum": ["Critical", "High", "Medium", "Low", "Critical Low"]},
        "calculated_at": {"type": "string", "format": "date-time"}
      }
    },
    "mcp_chain_execution": {
      "type": "object",
      "description": "Protocol: mcp_chain_enforcement_protocol - Validate all 4 MCP steps executed",
      "properties": {
        "sequential_thinking_executed": {"type": "boolean"},
        "memory_query_executed": {"type": "boolean"},
        "research_executed": {"type": "boolean"},
        "pattern_stored": {"type": "boolean"},
        "all_steps_complete": {"type": "boolean"},
        "chain_validation_timestamp": {"type": "string", "format": "date-time"}
      }
    },
    "mcp_integration_state": {
      "type": "object",
      "description": "Simple MCP server status tracking",
      "properties": {
        "filesystem": {"type": "string"},
        "context7": {"type": "string"},
        "memory": {"type": "string"},
        "sequential_thinking": {"type": "string"},
        "fetch": {"type": "string"},
        "time": {"type": "string"},
        "git": {"type": "string"},
        "math": {"type": "string"},
        "exa": {"type": "string"}
      }
    },
    "schema_compliance": {
      "type": "object",
      "properties": {
        "total_schemas": {"type": "integer", "minimum": 0},
        "schemas_validated": {"type": "integer", "minimum": 0},
        "total_size_kb": {"type": "number", "minimum": 0},
        "size_limit_kb": {"type": "number"},
        "compliance_score": {"type": "number", "minimum": 0, "maximum": 100},
        "helper_schemas_present": {"type": "integer", "minimum": 0}
      }
    },
    "recent_completions": {
      "type": "array",
      "maxItems": 10,
      "items": {
        "type": "object",
        "properties": {
          "task": {"type": "string"},
          "completed_at": {"type": "string", "format": "date-time"},
          "outcome": {"type": "string"}
        }
      }
    },
    "blockers": {
      "type": "array",
      "items": {"type": "string"}
    },
    "next_action": {
      "type": "object",
      "properties": {
        "workflow": {"type": "string"},
        "priority_task": {"type": "string"},
        "ready_to_execute": {"type": "boolean"},
        "note": {"type": "string"}
      }
    },
    "user_feedback": {
      "type": "object",
      "description": "Real-time progress updates for user visibility (UX Gap 1 fix)",
      "properties": {
        "current_action": {"type": "string", "description": "Human-readable current operation"},
        "progress_step": {"type": "string", "description": "e.g., 'Step 3 of 7'"},
        "estimated_time_remaining": {"type": "string", "description": "e.g., '2 minutes remaining'"},
        "last_update": {"type": "string", "format": "date-time"},
        "status": {"type": "string", "enum": ["working", "waiting", "paused", "completed", "error"]},
        "workflow_chain": {"type": "string", "description": "e.g., '/research → /next → /validate'"},
        "visible_to_user": {"type": "boolean", "default": true}
      }
    },
    "user_controls": {
      "type": "object",
      "description": "UX Gap 9 fix: User can pause/stop/cancel autonomous operations",
      "properties": {
        "pause_requested": {"type": "boolean", "default": false, "description": "User wants to pause execution"},
        "stop_requested": {"type": "boolean", "default": false, "description": "User wants to stop completely"},
        "skip_current_task": {"type": "boolean", "default": false, "description": "User wants to skip current and move to next"},
        "request_timestamp": {"type": "string", "format": "date-time"},
        "checkpoint_saved": {"type": "boolean", "default": false}
      }
    },
    "feedback_pending": {
      "type": "object",
      "description": "UX Gap 11 fix: Explicit user feedback loop for AI learning",
      "properties": {
        "action_id": {"type": "string", "description": "Unique ID for the action requiring feedback"},
        "prompt": {"type": "string", "description": "Question to ask user"},
        "action_description": {"type": "string", "description": "What was done in plain English"},
        "user_rating": {"type": "integer", "minimum": 1, "maximum": 5, "description": "1-5 stars"},
        "user_comment": {"type": "string"},
        "timestamp": {"type": "string", "format": "date-time"}
      }
    },
    "offline_mode": {
      "type": "object",
      "description": "UX Gap 13 fix: Graceful degradation when internet unavailable",
      "properties": {
        "internet_available": {"type": "boolean", "default": true},
        "last_check": {"type": "string", "format": "date-time"},
        "degraded_services": {"type": "array", "items": {"type": "string"}, "description": "List of MCPs unavailable (context7, exa, fetch)"},
        "fallback_strategy": {"type": "string", "enum": ["use_cached_patterns", "halt_and_notify", "continue_with_degraded"], "default": "use_cached_patterns"},
        "user_notified": {"type": "boolean", "default": false}
      }
    },
    "workspace_context": {
      "type": "object",
      "description": "UX Gap 15 fix: Multi-workspace awareness and disambiguation",
      "properties": {
        "workspace_name": {"type": "string", "description": "Human-readable project name"},
        "workspace_path": {"type": "string", "description": "Absolute path to workspace root"},
        "other_workspaces_active": {"type": "array", "items": {"type": "string"}, "description": "List of other open workspaces"},
        "cross_workspace_tasks": {"type": "boolean", "default": false, "description": "Is this task affecting multiple workspaces?"},
        "display_in_feedback": {"type": "boolean", "default": true, "description": "Show workspace name in every response"}
      }
    },
    "mcp_fallback_chain": {
      "type": "object",
      "description": "Gap 21 fix: MCP failure resilience with cascading fallbacks",
      "properties": {
        "context7_fallback": {"type": "array", "items": {"type": "string"}, "default": ["fetch", "exa", "memory_patterns"]},
        "exa_fallback": {"type": "array", "items": {"type": "string"}, "default": ["fetch", "context7", "memory_patterns"]},
        "all_research_failed_strategy": {"type": "string", "enum": ["use_llm_knowledge_with_warning", "halt_and_notify", "skip_task"], "default": "use_llm_knowledge_with_warning"},
        "max_retry_per_mcp": {"type": "integer", "default": 3},
        "fallback_history": {"type": "array", "items": {"type": "object"}, "maxItems": 10}
      }
    },
    "mcp_rate_limits": {
      "type": "object",
      "description": "Gap 22 fix: Track and enforce MCP API rate limits",
      "properties": {
        "context7": {"type": "object", "properties": {"limit": {"type": "integer", "default": 100}, "window": {"type": "string", "default": "daily"}, "current": {"type": "integer", "minimum": 0}}},
        "exa": {"type": "object", "properties": {"limit": {"type": "integer", "default": 50}, "window": {"type": "string", "default": "daily"}, "current": {"type": "integer", "minimum": 0}}},
        "fetch": {"type": "object", "properties": {"limit": {"type": "integer", "default": 200}, "window": {"type": "string", "default": "daily"}, "current": {"type": "integer", "minimum": 0}}},
        "alert_threshold": {"type": "number", "default": 0.8, "description": "Alert when reaching 80% of limit"},
        "last_reset": {"type": "string", "format": "date-time"}
      }
    },
    "mcp_performance_metrics": {
      "type": "object",
      "description": "Gap 23 fix: Monitor MCP performance and reliability",
      "properties": {
        "context7": {"type": "object", "properties": {"avg_latency_ms": {"type": "number"}, "success_rate": {"type": "number", "minimum": 0, "maximum": 1}, "total_calls": {"type": "integer"}}},
        "exa": {"type": "object", "properties": {"avg_latency_ms": {"type": "number"}, "success_rate": {"type": "number", "minimum": 0, "maximum": 1}, "total_calls": {"type": "integer"}}},
        "memory": {"type": "object", "properties": {"avg_latency_ms": {"type": "number"}, "success_rate": {"type": "number", "minimum": 0, "maximum": 1}, "total_calls": {"type": "integer"}}},
        "filesystem": {"type": "object", "properties": {"avg_latency_ms": {"type": "number"}, "success_rate": {"type": "number", "minimum": 0, "maximum": 1}, "total_calls": {"type": "integer"}}},
        "last_updated": {"type": "string", "format": "date-time"}
      }
    },
    "nlu_analysis": {
      "type": "object",
      "description": "Gap 24-26 fix: NLU confidence, ambiguity, and multi-language support",
      "properties": {
        "primary_intent": {"type": "object", "properties": {"intent": {"type": "string"}, "confidence": {"type": "number", "minimum": 0, "maximum": 1}}},
        "secondary_intent": {"type": "object", "properties": {"intent": {"type": "string"}, "confidence": {"type": "number", "minimum": 0, "maximum": 1}}},
        "confidence_threshold": {"type": "number", "default": 0.7, "description": "Minimum confidence to proceed"},
        "ambiguous": {"type": "boolean", "default": false},
        "clarification_prompt": {"type": "string", "description": "What to ask user if ambiguous"},
        "detected_language": {"type": "string", "default": "en", "description": "ISO 639-1 code"},
        "translation_needed": {"type": "boolean", "default": false},
        "supported_languages": {"type": "array", "items": {"type": "string"}, "default": ["en", "es", "fr", "de", "hi", "zh", "ja", "ru"]}
      }
    },
    "context_window_chain": {
      "type": "object",
      "description": "Doubly linked list structure for eternal memory continuity across context window breaks",
      "required": ["current_id", "chain_active"],
      "properties": {
        "current_id": {
          "type": "string",
          "description": "Unique ID for current context window (timestamp-based)"
        },
        "prev_id": {
          "type": "string",
          "description": "ID of previous context window in chain (null if first)"
        },
        "next_id": {
          "type": "string",
          "description": "ID of next context window in chain (null if current)"
        },
        "summary": {
          "type": "string",
          "description": "Condensed summary of current context window state"
        },
        "scratchpad_snapshot": {
          "type": "object",
          "description": "Snapshot of scratchpad at context break for seamless continuation",
          "properties": {
            "priority_queue": {"type": "array"},
            "current_task": {"type": "object"},
            "learnings": {"type": "array"},
            "timestamp": {"type": "string", "format": "date-time"}
          }
        },
        "chain_active": {
          "type": "boolean",
          "default": true,
          "description": "Whether context chain tracking is active"
        },
        "chain_length": {
          "type": "integer",
          "minimum": 1,
          "description": "Position in chain (1 = first context window)"
        },
        "total_chain_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Total number of context windows in chain"
        },
        "last_break_timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "When last context window break occurred"
        },
        "continuity_verified": {
          "type": "boolean",
          "default": false,
          "description": "Whether continuation from previous context was successfully loaded"
        }
      }
    }
  }
}
